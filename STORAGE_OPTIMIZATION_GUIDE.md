# Supabase 存儲空間節省方案

## 📋 方案概述

本方案為您的飲食助理應用提供全面的存儲空間節省解決方案，幫助您在 Supabase 免費限制內最大化應用性能。

## 🎯 核心功能

### 1. 智能圖片壓縮 📷
**文件位置：** `src/utils/imageCompression.js`

**功能特點：**
- ✅ 自動檢測圖片大小並調整壓縮參數
- ✅ 支持 WebP 格式轉換（比 JPEG 節省 25-35% 空間）
- ✅ 保持高品質的同時大幅減少文件大小
- ✅ 智能尺寸調整（最大 800x600 像素）

**壓縮策略：**
- 超大文件（>10MB）：激進壓縮（60% 質量，600x450）
- 大文件（5-10MB）：中等壓縮（70% 質量，700x525）
- 中等文件（>1MB）：輕度壓縮（80% 質量，800x600）
- 小文件（<1MB）：優化格式（85% 質量，轉換為 WebP）

**預期節省：** 60-80% 存儲空間

### 2. 自動清理舊圖片 🧹
**文件位置：** `src/utils/storageManager.js`

**清理策略：**
- ✅ 自動刪除 30 天前的圖片
- ✅ 每個用戶最多保留 100 張圖片
- ✅ 總存儲限制在 400MB 以內
- ✅ 每日自動執行清理

**實現方式：**
- 用戶登入時自動觸發
- 手動清理功能
- 清理前確認和日志記錄

### 3. 存儲空間監控 📊
**組件位置：** `src/components/StorageMonitor.vue`

**監控功能：**
- ✅ 實時顯示存儲使用情況
- ✅ 進度條和百分比顯示
- ✅ 使用量警告（70%、80%、90%）
- ✅ 預估可用天數計算

**整合位置：**
- 儀表板頁面（快速查看）
- 個人資料頁面（詳細管理）

### 4. 用戶存儲配額管理 ⚙️
**整合位置：** `src/views/Profile.vue`

**配額設定：**
- ✅ 可調整最大圖片保存數量（50/100/200/500 張）
- ✅ 自動壓縮開關
- ✅ 自動清理開關
- ✅ WebP 格式優先設定

## 🔧 技術實現

### 圖片處理流程
```javascript
1. 用戶選擇圖片
2. 檢查文件大小
3. 自動壓縮（如需要）
4. 格式優化（WebP/JPEG）
5. 上傳到 Supabase Storage
6. 記錄到數據庫
```

### 自動清理流程
```javascript
1. 用戶登入觸發檢查
2. 獲取用戶所有圖片記錄
3. 按時間和數量篩選待刪除項目
4. 刪除 Storage 中的文件
5. 刪除數據庫記錄
6. 更新使用統計
```

## 📈 預期效果

### 空間節省效果
- **圖片壓縮：** 平均節省 70% 空間
- **格式優化：** WebP 比 JPEG 節省 30% 空間
- **自動清理：** 避免累積過多歷史數據

### 實際案例
- **原始圖片：** 3MB
- **壓縮後：** 0.9MB（節省 70%）
- **WebP 格式：** 0.6MB（額外節省 33%）
- **總節省：** 80% 空間

## 🎛️ 用戶控制選項

### 儀表板快速控制
- 存儲狀況概覽
- 一鍵清理按鈕
- 存儲監控顯示/隱藏

### 個人資料詳細設定
- 壓縮質量偏好
- 清理策略調整
- 存儲配額管理
- 使用統計查看

## 🚀 使用方法

### 1. 查看存儲狀況
1. 進入儀表板
2. 點擊「查看存儲狀況」
3. 查看使用百分比和剩餘空間

### 2. 手動清理
1. 在存儲監控中點擊「智能清理」
2. 或選擇特定清理方式：
   - 清理 30 天前圖片
   - 清理超量圖片

### 3. 調整設定
1. 進入個人資料頁面
2. 在「存儲配額」區域調整設定：
   - 開啟/關閉自動壓縮
   - 開啟/關閉自動清理
   - 設定最大圖片數量

## ⚠️ 注意事項

### Supabase 免費限制
- **存儲空間：** 1GB
- **數據庫：** 500MB
- **月度流量：** 1GB

### 建議設定
- 保持自動壓縮開啟
- 保持自動清理開啟
- 最大圖片數量設為 100-200 張
- 定期檢查存儲使用狀況

### 安全性考慮
- 清理前會檢查文件是否存在
- 刪除操作包含錯誤處理
- 清理結果會記錄並顯示

## 🔮 未來擴展

### 可能的改進
1. **批量操作：** 支持批量刪除選定圖片
2. **雲端備份：** 整合其他雲端存儲服務
3. **智能分析：** 基於 AI 識別重複或模糊圖片
4. **用戶通知：** 存儲空間不足時發送提醒

### 監控指標
1. **平均壓縮率：** 追蹤壓縮效果
2. **清理頻率：** 分析清理模式
3. **用戶行為：** 了解存儲使用習慣

## 📞 支持與維護

### 故障排除
1. **壓縮失敗：** 檢查瀏覽器對 Canvas API 的支持
2. **清理失敗：** 確認 Supabase 連接和權限
3. **監控異常：** 刷新頁面或重新登入

### 日志記錄
- 所有壓縮和清理操作都會記錄到控制台
- 錯誤信息會顯示在用戶界面
- 成功操作會顯示詳細統計

---

**總結：** 此方案通過智能壓縮、自動清理、實時監控和用戶配額管理，能夠有效地在 Supabase 免費限制內最大化應用性能，為用戶提供最佳的體驗。